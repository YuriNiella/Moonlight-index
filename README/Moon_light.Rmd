---
title: "The mountain effect: calculating moon light during fishing"
author: "Yuri Niella"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
	echo = TRUE)
```

## 1. Overview

The **moon** is widely known to influence movement patterns of marine animals and, therefore, fishing activity in a variety of ways. It's major effects are upon **tide levels** and **environmental light** during night-time periods. Here we provide a standardized way for fishery researchers to obtain different moon measurements in fine scale for statistical analysis of catch-and-effort data. 
Fishing sets during exclusively daytime (including **dawn** and **dusk** periods) are automatically identified, and only sets that fished during trully night-time periods (**pre-dawn** or **after-dusk**) for some time are considered for analysis. The following **moon variables** are obtained using the `lunar` (Lazaridis, 2014) and `suncalc` (Thieurmel & Elmarhraoui, 2019) packages:  

(1) Time (UTC) and maximum angle (radians) of the moon in the sky during each fishing gear deployment

And the following ones for the time of maximum angle in the sky:

(2) Moon illumination: illuminated fraction of the moon (0 = new moon, 1 = full moon)
(3) Moon phase (0 = new moon, 0.25 = first quarter, 0.5 = full moon, 0.75 = last quarter)
(4) Distance from the earth (km)
(5) Time (UTC) of moon set
(6) Parallatic and Azimuth angles (radians) at the time of maximum angle in the sky

These variables can be then used to calculate the actual **fine scale moon light** during gear deployment. This approach takes into account the "mountain effect" (Niella et al., 2020). The **mountain effect** implies that, for the moon to have any expected effect, it's maximum angle in the sky during a fishing set has to enable it to transpass the height of the nearest mountain:

![**A.** The maximum angle of the moon is not enough to illuminate the other side of the island; **B.** The maximum angle of the moon allows it to illuminate the other side of the island.](Image1.png){#id .class width=110% height=110%} 

Not only the moon has to be **high enough** in the sky during a fishing set, but also the amount of **cloud cover** will influence the total moon light that reaches the surface of the water. Therefore, daily average cloud cover (in percentage) has to be provided for calculating the **fine scale moon light**. 


## 2. Obtaining moon variables

The `MoonVar()` function can be used by simply providing the locations of gear deployment (**Lon** and **Lat** in decimal degrees) and the respective set and retrieval times (in **UTC**) as input for analysis:

|    Lon|     Lat|            Time.set|            Time.ret| 
|:------|-------:|-------------------:|-------------------:|
| 55.275| -20.992| 2014-01-14 11:52:00| 2014-01-14 18:10:00| 
| 55.276| -20.992| 2014-01-14 18:10:00| 2014-01-15 03:50:00|
| 55.277| -20.983| 2014-01-14 12:10:00| 2014-01-14 17:55:00| 
| 55.276| -20.992| 2014-01-15 03:50:00| 2014-01-15 13:10:00| 
| 55.277| -20.983| 2014-01-15 04:05:00| 2014-01-15 13:20:00| 

```
moon.data <- MoonVar(data)
Identifying sets during exclusively daytime periods
  |============================================================| 100%
M: A total of 1961 sets were deployed exclusively during day light and will be removed.
M: A total of 84 sets were longer than 24-h and will be also removed.
Identifying times of maximum moon angle during fishing sets
  |============================================================| 100%
Downloading moon variables
  |============================================================| 100%
M: Saving diagnostic plot.
```
Please note that in this example a total of **1961** sets fished exclusively during **daytime** and were thus excluded from analysis. Another **84** sets had deployment times **longer than 24-h** (encompassing multiple nights) and were also excluded.

The output of this function is a list containing: 

(1) The processed fishing sets including the respective moon variables:

`head(moon.data$data)`

| Angle|       Max.moon.time| Illumin| Phase| Distance|       Moon.set.time| Parallatic|  Azimuth|
|:-----|-------------------:|-------:|-----:|--------:|-------------------:|----------:|--------:|
| 0.815| 2014-01-14 18:10:00|   0.982| 0.456| 404942.7| 2014-01-15 01:07:03|     -2.708|   -2.701|
| 0.788| 2014-01-14 17:55:00|   0.982| 0.457| 404927.8| 2014-01-15 01:07:03|     -2.633|   -2.624|
| 0.882| 2014-01-14 19:25:00|   0.982| 0.457| 405015.8| 2014-01-15 01:07:03|      3.136|    3.136|
| 0.879| 2014-01-14 19:10:00|   0.982| 0.457| 405001.4| 2014-01-15 01:07:03|     -3.054|   -3.052|
| 0.911| 2014-01-15 20:20:00|   0.997| 0.483| 405873.1| 2014-01-16 01:56:52|      3.079|    3.078| 
| 0.912| 2014-01-15 20:05:00|   0.997| 0.483| 405870.2| 2014-01-16 01:56:52|     -3.107|   -3.105|


(2) An integer vector identifying which sets (row numbers) from the input dataset fished exclusively during daytime periods:

```
length(moon.data$set.index)
[1] 2045 # 1961 daytime + 84 longer tha 24-h!

summary(moon.data$set.index)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      5    1619    4986    4781    7491    9708 
```

(3) A diagnostic plot showing the distributions of (a) **soak times**, (b) **time intervals** between **maximum moon angle** and **retrieval**, and (c) **maximum moon angles**:

`moon.data$diagnostic`
![](Image2.png){#id .class width=120% height=120%} 


## 3. Calculating fine scale moon light 





